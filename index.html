<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ó–∞–∫–∞–∑ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ –∏ –°–Ω–µ–≥—É—Ä–æ—á–∫–∏</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial Rounded MT Bold', Arial, sans-serif;
            background: linear-gradient(135deg, #87CEEB, #B0E2FF); 
            color: #2F4F4F; 
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        .snowflake {
            position: absolute;
            background: white;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0.8;
            animation: fall linear infinite;
        }
        @keyframes fall {
            to {
                transform: translateY(100vh);
            }
        }
        .snowdrift {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 200px;
            background: linear-gradient(to top, #ffffff, #f0f8ff);
            z-index: 5;
            border-top-left-radius: 50% 30px;
            border-top-right-radius: 50% 30px;
            box-shadow: 0 -5px 20px rgba(255, 255, 255, 0.5);
        }
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(47, 79, 79, 0.3);
            position: relative;
            z-index: 10;
            margin-bottom: 100px; 
            color: #2F4F4F;
        }
        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #32CD32; 
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        h2 {
            color: #228B22; 
            border-bottom: 2px solid #32CD32;
            padding-bottom: 10px;
        }
        h3 {
            color: #228B22;
        }
        .tariff-card {
            background: rgba(240, 248, 255, 0.9);
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #32CD32; 
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #32CD32; 
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            color: #2F4F4F;
        }
        button {
            background: #32CD32; 
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s;
            display: inline-block;
        }
        button:hover {
            background: #228B22; 
            transform: scale(1.05);
        }
        .price-display {
            font-size: 1.5em;
            color: #228B22; 
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
        }
        .error {
            color: #CD5C5C; 
            margin: 10px 0;
            text-align: center;
        }
        .suggestions {
            background: rgba(173, 216, 230, 0.5); 
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }
        .payment-section {
            background: rgba(240, 248, 255, 0.8); 
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid #32CD32;
        }
        /* === –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ === */
        @media (max-width: 768px) {
            .form-container {
                padding: 15px;
                margin: 10px;
                margin-bottom: 150px; 
            }
            h1 {
                font-size: 2em;
            }
            button {
                padding: 12px 20px;
                font-size: 16px;
                width: 100%;
                margin: 10px 0;
            }
            .tariff-card {
                padding: 15px;
            }
        }
        @media (max-width: 480px) {
            h1 {
                font-size: 1.8em;
            }
            .price-display {
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <div id="snowflakes"></div>
    <div class="form-container">
        <h1>üéÑ –ó–∞–∫–∞–∂–∏ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ –∏ –°–Ω–µ–≥—É—Ä–æ—á–∫—É!</h1>
        <div id="tariffs">
            <h2>–¢–∞—Ä–∏—Ñ—ã</h2>
            <div class="tariff-card">
                <h3>–≠–∫—Å–ø—Ä–µ—Å—Å (10 –º–∏–Ω—É—Ç)</h3>
                <p>–ö—Ä–∞—Ç–∫–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ: —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ, –±–µ–Ω–≥–∞–ª—å—Å–∫–∏–µ –æ–≥–Ω–∏, —Ö–æ—Ä–æ–≤–æ–¥, –ø–µ—Å–µ–Ω–∫–∞ –ø—Ä–æ –ù–æ–≤—ã–π –≥–æ–¥.</p>
                <p><strong>–ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</strong></p>
            </div>
            <div class="tariff-card">
                <h3>–°—Ç–∞–Ω–¥–∞—Ä—Ç (30 –º–∏–Ω—É—Ç)</h3>
                <p>–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞: –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ, —Ö–æ—Ä–æ–≤–æ–¥, –∏–≥—Ä—ã, –∫–æ–Ω–∫—É—Ä—Å—ã, –∑–∞–≥–∞–¥–∫–∏, –ø–µ—Å–Ω–∏, —Å–∫–∞–∑–∫–∞.</p>
                <p><strong>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –¥–ª—è –¥–µ—Ç—Å–∫–∏—Ö –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤</strong></p>
            </div>
            <div class="tariff-card">
                <h3>–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π (1 —á–∞—Å)</h3>
                <p>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –Ω–∞—Å—ã—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞: –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã, –∫–æ–Ω–∫—É—Ä—Å—ã, —Å—Ü–µ–Ω–∫–∏, –ø–æ–¥–∞—Ä–∫–∏, —á–∞–µ–ø–∏—Ç–∏–µ.</p>
                <p><strong>–î–ª—è –±–æ–ª—å—à–∏—Ö –∫–æ–º–ø–∞–Ω–∏–π –∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–æ–≤</strong></p>
            </div>
        </div>
        <div style="height: 30px;"></div>
        <div id="orderForm">
            <!-- –®–∞–≥ 1: –ì–æ—Ä–æ–¥ -->
            <div class="step active" id="step1">
                <h2>–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ?</h2>
                <select id="city" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                    <option value="–ú–æ—Å–∫–≤–∞">–ú–æ—Å–∫–≤–∞ (–¥–æ 50 –ø–∞—Ä)</option>
                    <option value="–°–ü–±">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ (–¥–æ 27 –ø–∞—Ä)</option>
                </select>
                <button onclick="nextStep(2)">–î–∞–ª–µ–µ</button>
            </div>
            <!-- –®–∞–≥ 2: –ü—Ä–æ–≥—Ä–∞–º–º–∞ -->
            <div class="step" id="step2">
                <h2>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É</h2>
                <div>
                    <label>
                        <input type="radio" name="program" value="–≠–∫—Å–ø—Ä–µ—Å—Å (10 –º–∏–Ω)"> <strong>–≠–∫—Å–ø—Ä–µ—Å—Å (10 –º–∏–Ω)</strong>
                    </label><br>
                    <label>
                        <input type="radio" name="program" value="–°—Ç–∞–Ω–¥–∞—Ä—Ç (30 –º–∏–Ω)"> <strong>–°—Ç–∞–Ω–¥–∞—Ä—Ç (30 –º–∏–Ω)</strong>
                    </label><br>
                    <label>
                        <input type="radio" name="program" value="–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π (1 —á–∞—Å)"> <strong>–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π (1 —á–∞—Å)</strong>
                    </label>
                </div>
                <button onclick="prevStep(1)">–ù–∞–∑–∞–¥</button>
                <button onclick="nextStep(3)">–î–∞–ª–µ–µ</button>
            </div>
            <!-- –®–∞–≥ 3: –î–∞—Ç–∞ -->
            <div class="step" id="step3">
                <h2>–ö–æ–≥–¥–∞?</h2>
                <input type="date" id="date" min="2025-12-25" max="2026-01-07" required>
                <button onclick="prevStep(2)">–ù–∞–∑–∞–¥</button>
                <button onclick="nextStep(4)">–î–∞–ª–µ–µ</button>
            </div>
            <!-- –®–∞–≥ 4: –í—Ä–µ–º—è (—Å —Ü–µ–Ω–æ–π) -->
            <div class="step" id="step4">
                <h2>–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</h2>
                <div id="timeSlotsContainer"></div>
                <div id="priceDisplay" class="price-display">–¶–µ–Ω–∞: ‚Äî</div>
                <div id="error" class="error"></div>
                <button onclick="prevStep(3)">–ù–∞–∑–∞–¥</button>
                <button onclick="nextStep(5)">–î–∞–ª–µ–µ</button>
            </div>
            <!-- –®–∞–≥ 5: –ê–¥—Ä–µ—Å –∏ –¥–µ—Ç–∏ -->
            <div class="step" id="step5">
                <h2>–ì–¥–µ?</h2>
                <input type="text" id="address" placeholder="–ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å" required>
                <input type="number" id="children_count" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π" min="1" required>
                <input type="text" id="child_name" placeholder="–ò–º—è —Ä–µ–±—ë–Ω–∫–∞" required>
                <button onclick="prevStep(4)">–ù–∞–∑–∞–¥</button>
                <button onclick="nextStep(6)">–î–∞–ª–µ–µ</button>
            </div>
            <!-- –®–∞–≥ 6: –ö–æ–Ω—Ç–∞–∫—Ç –∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è -->
            <div class="step" id="step6">
                <h2>–ö–æ–Ω—Ç–∞–∫—Ç –∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è</h2>
                <input type="text" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+79991234567)" required>
                <textarea id="comments" placeholder="–ü–æ–∂–µ–ª–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="3"></textarea>
                <button onclick="prevStep(5)">–ù–∞–∑–∞–¥</button>
                <button onclick="sendOrder()">–û–ø–ª–∞—Ç–∏—Ç—å</button>
            </div>
            <!-- –®–∞–≥ 7: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø–ª–∞—Ç—ã -->
            <div class="step" id="step7">
                <h2>–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</h2>
                <div id="orderSummary"></div>
                <div class="payment-section">
                    <p>–î–ª—è –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:</p>
                    <button onclick="proceedToPayment()">üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ –ÆMoney (–∑–∞–≥–ª—É—à–∫–∞)</button>
                    <p style="font-size: 0.9em; color: #2F4F4F; margin-top: 10px;">
                        –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
                    </p>
                </div>
                <button onclick="prevStep(6)">–ù–∞–∑–∞–¥</button>
            </div>
            <!-- –®–∞–≥ 8: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã -->
            <div class="step" id="step8">
                <h2>–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!</h2>
                <p>–í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –∏ –∑–∞–ø–∏—Å–∞–Ω –≤ —Å–∏—Å—Ç–µ–º—É.</p>
                <p><strong>ID –≤–∞—à–µ–≥–æ –∑–∞–∫–∞–∑–∞:</strong> <span id="orderIdDisplay" style="color: #32CD32; font-weight: bold;"></span></p>
                <p>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ, —á—Ç–æ–±—ã –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞.</p>
                <p>–î–ª—è —ç—Ç–æ–≥–æ:</p>
                <ol>
                    <li>–ù–∞–π–¥–∏—Ç–µ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞ –≤ Telegram.</li>
                    <li>–ù–∞–∂–º–∏—Ç–µ /start.</li>
                    <li>–í—ã–±–µ—Ä–∏—Ç–µ "üîë –í–≤–µ—Å—Ç–∏ ID –∑–∞–∫–∞–∑–∞".</li>
                    <li>–í–≤–µ–¥–∏—Ç–µ —ç—Ç–æ—Ç ID: <span id="orderIdForBot" style="color: #32CD32; font-weight: bold;"></span></li>
                </ol>
                <button onclick="location.reload()">–°–¥–µ–ª–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑</button>
            </div>
        </div>
    </div>
    <!-- === –°–£–ì–†–û–ë–´ === -->
    <div class="snowdrift"></div>
    <script>
        // === –°–ù–ï–ñ–ò–ù–ö–ò ===
        function createSnowflakes() {
            const container = document.getElementById('snowflakes');
            const snowflakeCount = 50;
            for (let i = 0; i < snowflakeCount; i++) {
                const snowflake = document.createElement('div');
                snowflake.classList.add('snowflake');
                snowflake.style.left = Math.random() * 100 + 'vw';
                snowflake.style.width = Math.random() * 5 + 5 + 'px';
                snowflake.style.height = snowflake.style.width;
                snowflake.style.animationDuration = Math.random() * 5 + 5 + 's';
                snowflake.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(snowflake);
            }
        }

        // === –§–£–ù–ö–¶–ò–ò –ù–ê–í–ò–ì–ê–¶–ò–ò ===
        function nextStep(step) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
        }
        function prevStep(step) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
        }

        // === –§–£–ù–ö–¶–ò–Ø –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø –î–ê–¢–´ (–¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ API) ===
        function formatDateToDisplay(dateStr) {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) {
                return '';
            }
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        }
                // === –û–ë–ù–û–í–õ–Å–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –í–†–ï–ú–ï–ù–ù–´–• –°–õ–û–¢–û–í (—Å —Ü–µ–Ω–æ–π, —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π API) ===
        async function updateTimeSlots() {
            const dateInput = document.getElementById('date');
            const dateValue = dateInput.value; // –≠—Ç–æ –±—É–¥–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
            const program = document.querySelector('input[name="program"]:checked');
            const timeSlotsContainer = document.getElementById('timeSlotsContainer');
            const priceDisplay = document.getElementById('priceDisplay');
            const errorDiv = document.getElementById('error');

            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            timeSlotsContainer.innerHTML = '';
            priceDisplay.textContent = '–¶–µ–Ω–∞: ‚Äî';
            errorDiv.textContent = '';

            // --- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã–±—Ä–∞–Ω—ã ---
            if (!dateValue || !program) {
                // –ù–µ –≥—Ä—É–∑–∏–º —Å–ª–æ—Ç—ã, –µ—Å–ª–∏ –Ω–µ –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã–±—Ä–∞–Ω—ã
                console.log("updateTimeSlots: –ù–µ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã–±—Ä–∞–Ω—ã (date –∏–ª–∏ program).");
                return; // –ü—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Ö–æ–¥–∏—Ç –ª–∏ –¥–∞—Ç–∞ –≤ –¥–æ–ø—É—Å—Ç–∏–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω
            const selectedDate = new Date(dateValue);
            const minDate = new Date('2025-12-25');
            const maxDate = new Date('2026-01-07');

            if (selectedDate < minDate || selectedDate > maxDate) {
                errorDiv.textContent = '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É —Å 25 –¥–µ–∫–∞–±—Ä—è 2025 –ø–æ 07 —è–Ω–≤–∞—Ä—è 2026.';
                return; 
            }

            const displayDate = formatDateToDisplay(dateValue);

            // --- –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ displayDate –Ω–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ ---
            if (!displayDate) {
                 console.log("updateTimeSlots: displayDate –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞. –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç dateValue?");
                 errorDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã.';
                 return;
            }

            const city = document.getElementById('city').value;

            // --- –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ city –≤—ã–±—Ä–∞–Ω ---
            if (!city) {
                 console.log("updateTimeSlots: –ì–æ—Ä–æ–¥ –Ω–µ –≤—ã–±—Ä–∞–Ω.");
                 errorDiv.textContent = '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥.';
                 return;
            }

            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã —Å —Ü–µ–Ω–∞–º–∏ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é —Å —Å–µ—Ä–≤–µ—Ä–∞
                const res = await fetch(`/api/time_slots?date=${encodeURIComponent(displayDate)}&city=${encodeURIComponent(city)}&program_type=${encodeURIComponent(program.value)}`);
                if (!res.ok) {
                    let errorMessage = `–û—à–∏–±–∫–∞ API: ${res.status}`;
                    try {
                        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–ª–æ –æ—à–∏–±–∫–∏ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
                        const errorData = await res.json();
                        if (errorData.error) {
                            errorMessage += ` - ${errorData.error} + ${displayDate}`;
                        }
                    } catch (e) {
                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—à–∏–±–∫–∏, –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Ç–µ–ª–æ –æ—à–∏–±–∫–∏ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", e);
                    }
                    throw new Error(errorMessage);
                }
                const data = await res.json();

                if (data.error) {
                    errorDiv.textContent = `‚ùå ${data.error}`;
                    return;
                }

                if (!data.slots || data.slots.length === 0) {
                    timeSlotsContainer.innerHTML = '<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É.</p>';
                    return;
                }

                let html = '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
                data.slots.forEach(slot => {
                    if (slot.available) {
                        html += `<button class="time-slot-btn" data-time="${slot.time}" data-price="${slot.price}">${slot.time} ‚Äî ${slot.price} ‚ÇΩ (–æ—Å—Ç–∞–ª–æ—Å—å ${slot.available_count})</button>`;
                    } else {
                        html += `<button class="time-slot-btn unavailable" disabled>${slot.time} ‚Äî ${slot.price} ‚ÇΩ (–Ω–µ—Ç –º–µ—Å—Ç)</button>`;
                    }
                });
                html += '</div>';
                timeSlotsContainer.innerHTML = html;

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—Ä–µ–º–µ–Ω–∏
                document.querySelectorAll('.time-slot-btn:not(.unavailable)').forEach(btn => {
                    btn.addEventListener('click', function() {
                        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö
                        document.querySelectorAll('.time-slot-btn').forEach(b => b.classList.remove('selected'));
                        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –Ω–∞–∂–∞—Ç–æ–π
                        this.classList.add('selected');
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–Ω—É
                        const price = this.getAttribute('data-price');
                        priceDisplay.textContent = `–¶–µ–Ω–∞: ${price} ‚ÇΩ`;
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
                        currentOrder.selectedTime = this.getAttribute('data-time');
                    });
                });

                // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã, –Ω–æ –Ω–∏ –æ–¥–∏–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω, —Å–±—Ä–æ—Å–∏–º —Ü–µ–Ω—É
                if (!document.querySelector('.time-slot-btn.selected')) {
                    priceDisplay.textContent = '–¶–µ–Ω–∞: ‚Äî';
                    currentOrder.selectedTime = null;
                }

            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–ª–æ—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–∏:', e);
                errorDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤: ${e.message}`;
                timeSlotsContainer.innerHTML = '';
            }
        }

        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤ –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—é –¥–∞—Ç—ã –∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã
        document.getElementById('date').addEventListener('change', updateTimeSlots);
        const programInputs = document.querySelectorAll('input[name="program"]');
        programInputs.forEach(input => input.addEventListener('change', updateTimeSlots));
        // –¢–∞–∫–∂–µ –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—é –≥–æ—Ä–æ–¥–∞, —Ç–∞–∫ –∫–∞–∫ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–µ–≥–æ
        document.getElementById('city').addEventListener('change', updateTimeSlots);


        // === –û–¢–ü–†–ê–í–ö–ê –ó–ê–ö–ê–ó–ê ===
        async function sendOrder() {
            const city = document.getElementById('city').value;
            const date = document.getElementById('date').value;
            const time = currentOrder.selectedTime; // –ë–µ—Ä—ë–º –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏
            const program = document.querySelector('input[name="program"]:checked');
            const address = document.getElementById('address').value;
            const children_count = document.getElementById('children_count').value;
            const child_name = document.getElementById('child_name').value;
            const phone = document.getElementById('phone').value;
            const comments = document.getElementById('comments').value;

            const errorDiv = document.getElementById('error');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
            if (!city || !date || !time || !program || !address || !children_count || !child_name || !phone) {
                errorDiv.textContent = '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.';
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            if (!phone.startsWith('+7') || phone.length !== 12) {
                 errorDiv.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç +7XXXXXXXXXX.';
                 return;
            }

            // –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑
            const data = {
                city: city,
                date: formatDateToDisplay(date), // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É
                time: time, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
                program_type: program.value, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–∫–∏
                address: address,
                children_count: children_count,
                child_name: child_name,
                phone: phone,
                comments: comments,
                price: parseFloat(document.getElementById('priceDisplay').textContent.replace('–¶–µ–Ω–∞: ', '').replace(' ‚ÇΩ', '')) || 0
            };

            const res = await fetch('/api/temp_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                const result = await res.json();
                currentOrder.order_id = result.order_id;

                document.getElementById('orderSummary').innerHTML = `
                    <p><strong>–ö–æ–≥–æ:</strong> –î–µ–¥ –ú–æ—Ä–æ–∑ –∏ –°–Ω–µ–≥—É—Ä–æ—á–∫–∞</p>
                    <p><strong>–ì–æ—Ä–æ–¥:</strong> ${data.city}</p>
                    <p><strong>–î–∞—Ç–∞:</strong> ${data.date} –≤ ${data.time}</p>
                    <p><strong>–ü—Ä–æ–≥—Ä–∞–º–º–∞:</strong> ${data.program_type}</p>
                    <p><strong>–¶–µ–Ω–∞:</strong> ${data.price} ‚ÇΩ</p>
                    <p><strong>–ê–¥—Ä–µ—Å:</strong> ${data.address}</p>
                    <p><strong>–î–µ—Ç–µ–π:</strong> ${data.children_count}</p>
                    <p><strong>–ò–º—è —Ä–µ–±—ë–Ω–∫–∞:</strong> ${data.child_name}</p>
                `;

                nextStep(7);
                errorDiv.textContent = ''; // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
            } else {
                const result = await res.json();
                errorDiv.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + result.error;
            }
        }

        // === –û–ü–õ–ê–¢–ê ===
        let currentOrder = {};

        function proceedToPayment() {
            alert("–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã (–∑–∞–≥–ª—É—à–∫–∞). –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ÆMoney.");
            setTimeout(() => {
                confirmOrderFromTemp(currentOrder.order_id);
            }, 1000);
        }

        async function confirmOrderFromTemp(order_id) {
            const res = await fetch('/api/confirm_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order_id: order_id })
            });

            if (res.ok) {
                document.getElementById('orderIdDisplay').textContent = order_id;
                document.getElementById('orderIdForBot').textContent = order_id;
                nextStep(8);
            } else {
                const result = await res.json();
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: ' + result.error);
            }
        }

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
        window.onload = function() {
            createSnowflakes();
            const dateInput = document.getElementById('date');
            dateInput.min = '2025-12-25';
            dateInput.max = '2026-01-07';
        };
    </script>
</body>
</html>

