<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ó–∞–∫–∞–∑ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ –∏ –°–Ω–µ–≥—É—Ä–æ—á–∫–∏</title>
    <style>
        body {
            font-family: 'Arial Rounded MT Bold', Arial, sans-serif;
            background: linear-gradient(135deg, #003f8a, #d4af37);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            text-align: center;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.5);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }
        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #d4af37;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: none;
            font-size: 16px;
        }
        button {
            background: #d4af37;
            color: #003f8a;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        button:hover {
            background: #f0c450;
            transform: scale(1.05);
        }
        .price-display {
            font-size: 1.5em;
            color: #d4af37;
            margin: 15px 0;
            font-weight: bold;
        }
        .character-img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin: 10px;
            border: 3px solid #d4af37;
        }
        .error { color: #ff6b6b; margin: 10px 0; }
        .suggestions { background: rgba(255, 255, 255, 0.2); padding: 10px; border-radius: 8px; margin: 10px 0; }
        .payment-section {
            background: rgba(0, 63, 138, 0.6);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÑ –ó–∞–∫–∞–∂–∏ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ –∏ –°–Ω–µ–≥—É—Ä–æ—á–∫—É!</h1>

        <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞ -->
        <div class="step active" id="step1">
            <h2>–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ?</h2>
            <select id="city" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                <option value="–ú–æ—Å–∫–≤–∞">–ú–æ—Å–∫–≤–∞ (–¥–æ 50 –ø–∞—Ä)</option>
                <option value="–°–ü–±">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ (–¥–æ 27 –ø–∞—Ä)</option>
            </select>
            <button onclick="nextStep(2)">–î–∞–ª–µ–µ</button>
        </div>

        <!-- –®–∞–≥ 2: –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è -->
        <div class="step" id="step2">
            <h2>–ö–æ–≥–¥–∞?</h2>
            <input type="text" id="date" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 24 –¥–µ–∫–∞–±—Ä—è 2024" required>
            <input type="text" id="time" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 14:00, 15:00, 16:00" required>
            <div id="priceDisplay" class="price-display">–¶–µ–Ω–∞: ‚Äî</div>
            <div id="error" class="error"></div>
            <div id="suggestions" class="suggestions" style="display:none;"></div>
            <button onclick="prevStep(1)">–ù–∞–∑–∞–¥</button>
            <button onclick="nextStep(3)">–î–∞–ª–µ–µ</button>
        </div>

        <!-- –®–∞–≥ 3: –¢–∏–ø –ø—Ä–æ–≥—Ä–∞–º–º—ã -->
        <div class="step" id="step3">
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É</h2>
            <div>
                <label>
                    <input type="radio" name="program" value="–≠–∫—Å–ø—Ä–µ—Å—Å (15 –º–∏–Ω)"> <strong>–≠–∫—Å–ø—Ä–µ—Å—Å (15 –º–∏–Ω)</strong> ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç –ø–æ–∑–∂–µ
                </label><br>
                <label>
                    <input type="radio" name="program" value="–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è (30 –º–∏–Ω)"> <strong>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è (30 –º–∏–Ω)</strong> ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç –ø–æ–∑–∂–µ
                </label>
            </div>
            <button onclick="prevStep(2)">–ù–∞–∑–∞–¥</button>
            <button onclick="nextStep(4)">–î–∞–ª–µ–µ</button>
        </div>

        <!-- –®–∞–≥ 4: –ê–¥—Ä–µ—Å –∏ –¥–µ—Ç–∏ -->
        <div class="step" id="step4">
            <h2>–ì–¥–µ?</h2>
            <input type="text" id="address" placeholder="–ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å" required>
            <input type="number" id="children_count" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π" min="1" required>
            <input type="text" id="child_name" placeholder="–ò–º—è —Ä–µ–±—ë–Ω–∫–∞" required>
            <button onclick="prevStep(3)">–ù–∞–∑–∞–¥</button>
            <button onclick="nextStep(5)">–î–∞–ª–µ–µ</button>
        </div>

        <!-- –®–∞–≥ 5: –ö–æ–Ω—Ç–∞–∫—Ç –∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è -->
        <div class="step" id="step5">
            <h2>–ö–æ–Ω—Ç–∞–∫—Ç –∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è</h2>
            <input type="text" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+79991234567)" required>
            <textarea id="comments" placeholder="–ü–æ–∂–µ–ª–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="3"></textarea>
            <button onclick="prevStep(4)">–ù–∞–∑–∞–¥</button>
            <button onclick="sendOrder()">–û–ø–ª–∞—Ç–∏—Ç—å</button>
        </div>

        <!-- –®–∞–≥ 6: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø–ª–∞—Ç—ã -->
        <div class="step" id="step6">
            <h2>–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</h2>
            <div id="orderSummary"></div>
            <div class="payment-section">
                <p>–î–ª—è –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:</p>
                <button onclick="proceedToPayment()">üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ –ÆMoney (–∑–∞–≥–ª—É—à–∫–∞)</button>
                <p style="font-size: 0.9em; color: #ccc; margin-top: 10px;">
                    –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
                </p>
            </div>
            <button onclick="prevStep(5)">–ù–∞–∑–∞–¥</button>
        </div>

        <!-- –®–∞–≥ 7: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã -->
        <div class="step" id="step7">
            <h2>–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!</h2>
            <p>–í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –∏ –∑–∞–ø–∏—Å–∞–Ω –≤ —Å–∏—Å—Ç–µ–º—É.</p>
            <button onclick="location.reload()">–°–¥–µ–ª–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑</button>
        </div>

        <p><a href="/download" target="_blank" style="color:#d4af37;">üì• –°–∫–∞—á–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤</a></p>
    </div>

    <script>
        let currentOrder = {};

        function nextStep(step) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
        }

        function prevStep(step) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
        }

        document.getElementById('date').addEventListener('input', updatePrice);
        document.getElementById('time').addEventListener('input', updatePrice);

        async function updatePrice() {
            const date = document.getElementById('date').value.trim();
            const time = document.getElementById('time').value.trim();
            const program = document.querySelector('input[name="program"]:checked');
            if (!date || !time || !program) return;

            const res = await fetch(`/api/price?date=${encodeURIComponent(date)}&time=${encodeURIComponent(time)}&program_type=${encodeURIComponent(program.value)}`);
            const data = await res.json();
            document.getElementById('priceDisplay').textContent = `–¶–µ–Ω–∞: ${data.price || '‚Äî'} ‚ÇΩ`;
        }

        async function sendOrder() {
            const data = {
                city: document.getElementById('city').value,
                date: document.getElementById('date').value,
                time: document.getElementById('time').value,
                program_type: document.querySelector('input[name="program"]:checked').value,
                address: document.getElementById('address').value,
                children_count: document.getElementById('children_count').value,
                child_name: document.getElementById('child_name').value,
                phone: document.getElementById('phone').value,
                comments: document.getElementById('comments').value,
                price: parseFloat(document.getElementById('priceDisplay').textContent.replace('–¶–µ–Ω–∞: ', '').replace(' ‚ÇΩ', '')) || 0
            };

            const res = await fetch('/api/temp_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                const result = await res.json();
                currentOrder.order_id = result.order_id;

                document.getElementById('orderSummary').innerHTML = `
                    <p><strong>–ö–æ–≥–æ:</strong> –î–µ–¥ –ú–æ—Ä–æ–∑ –∏ –°–Ω–µ–≥—É—Ä–æ—á–∫–∞</p>
                    <p><strong>–ì–æ—Ä–æ–¥:</strong> ${data.city}</p>
                    <p><strong>–î–∞—Ç–∞:</strong> ${data.date} –≤ ${data.time}</p>
                    <p><strong>–ü—Ä–æ–≥—Ä–∞–º–º–∞:</strong> ${data.program_type}</p>
                    <p><strong>–¶–µ–Ω–∞:</strong> ${data.price} ‚ÇΩ</p>
                    <p><strong>–ê–¥—Ä–µ—Å:</strong> ${data.address}</p>
                    <p><strong>–î–µ—Ç–µ–π:</strong> ${data.children_count}</p>
                    <p><strong>–ò–º—è —Ä–µ–±—ë–Ω–∫–∞:</strong> ${data.child_name}</p>
                `;

                nextStep(6);
            } else {
                const result = await res.json();
                alert('‚ùå –û—à–∏–±–∫–∞: ' + result.error);
            }
        }

        function proceedToPayment() {
            // –ó–∞–≥–ª—É—à–∫–∞ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤–Ω–µ—à–Ω—é—é —Å—Å—ã–ª–∫—É
            // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏: –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ÆMoney –∏–ª–∏ –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–∏—Å
            // –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—é–¥–∞ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç confirmOrderFromTemp
            alert("–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã (–∑–∞–≥–ª—É—à–∫–∞). –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ÆMoney.");
            // window.open('https://yoomoney.ru/...', '_blank'); // –†–µ–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤
            // –ü–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ ‚Äî –≤—ã–∑–≤–∞—Ç—å confirmOrderFromTemp(order_id)
            setTimeout(() => {
                confirmOrderFromTemp(currentOrder.order_id);
            }, 1000); // –°–∏–º—É–ª—è—Ü–∏—è
        }

        async function confirmOrderFromTemp(order_id) {
            const res = await fetch('/api/confirm_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order_id: order_id })
            });

            if (res.ok) {
                nextStep(7);
            } else {
                const result = await res.json();
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: ' + result.error);
            }
        }
    </script>
</body>
</html>